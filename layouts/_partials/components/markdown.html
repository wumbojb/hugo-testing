{{- /* Initialize content and placeholder storage */ -}}
{{- $content := .RawContent -}}          {{/* Get the raw Markdown content */}}
{{- $placeholders := slice -}}           {{/* Store masked sections (inline/code blocks) */}}
{{- $i := 0 -}}                          {{/* Counter for unique placeholder IDs */}}

{{- /* ------------------------------------ */ -}}
{{- /* 1. Mask inline code containing [[...]] or ![[...]] */ -}}
{{- $inlineMatches := findRE "`!?\\[\\[[^\\[\\]]+\\]\\]`" $content -}}  
{{/* Regex: match inline code wrapped in backticks that contains wikilink or image wikilink */}}
{{- range $inlineMatches -}}
  {{- $placeholder := printf "WIKILINK_PLACEHOLDER_%d" $i -}}   {{/* Create placeholder name */}}
  {{- $placeholders = $placeholders | append (dict "original" . "placeholder" $placeholder) -}}  
  {{/* Save mapping: original text → placeholder */}}
  {{- $content = replace $content . $placeholder -}}            {{/* Replace inline code with placeholder */}}
  {{- $i = add $i 1 -}}                                         {{/* Increment placeholder index */}}
{{- end -}}

{{- /* ------------------------------------ */ -}}
{{- /* 2. Mask entire code blocks containing [[...]] or ![[...]] */ -}}
{{- $codeBlockMatches := findRE "(?s)```.*?```" $content -}}    {{/* Regex: match fenced code blocks (triple backticks, multiline) */}}
{{- range $codeBlockMatches -}}
  {{- if or (findRE "\\[\\[.*?\\]\\]" .) (findRE "!\\[\\[.*?\\]\\]" .) -}}  
  {{/* Only replace if wikilink syntax is found inside the code block */}}
    {{- $placeholder := printf "WIKILINK_PLACEHOLDER_%d" $i -}}
    {{- $placeholders = $placeholders | append (dict "original" . "placeholder" $placeholder) -}}
    {{- $content = replace $content . $placeholder -}}   {{/* Mask the code block */}}
    {{- $i = add $i 1 -}}
  {{- end -}}
{{- end -}}

{{- /* ------------------------------------ */ -}}
{{- /* 3. Convert Image Wikilinks first */ -}}
{{- $content = replaceRE `!\[\[([^\|\]]+)\|([^\|\]]+)\|([^\]]+)\]\]` `![$2|$3](imageWikiLink "$1")` $content -}}  
{{/* Pattern: ![[file|alt|title]] → ![alt|title](imageWikiLink "file") */}}
{{- $content = replaceRE `!\[\[([^\|\]]+)\|([^\]]+)\]\]`         `![$2](imageWikiLink "$1")` $content -}}  
{{/* Pattern: ![[file|alt]] → ![alt](imageWikiLink "file") */}}
{{- $content = replaceRE `!\[\[([^\]]+)\]\]`                     `![$1](imageWikiLink "$1")` $content -}}  
{{/* Pattern: ![[file]] → ![file](imageWikiLink "file") */}}

{{- /* 4. Convert Regular Wikilinks to Markdown Links */ -}}
{{- $content = replaceRE `\[\[(https?://[^\|\]]+)\|([^\]]+)\]\]` `[$2]($1)` $content -}}  
{{/* [[https://url|text]] → [text](https://url) */}}
{{- $content = replaceRE `\[\[(https?://[^\]]+)\]\]`             `[$1]($1)` $content -}}  
{{/* [[https://url]] → [url](https://url) */}}
{{- $content = replaceRE `\[\[([^\|\]]+)\|([^\]]+)\]\]`          `[$2](wikilink "$1")` $content -}}  
{{/* [[page|text]] → [text](wikilink "page") */}}
{{- $content = replaceRE `\[\[([^\]]+)\]\]`                      `[$1](wikilink "$1")` $content -}}  
{{/* [[page]] → [page](wikilink "page") */}}

{{- /* ------------------------------------ */ -}}
{{- /* 5. Restore all placeholders to original content */ -}}
{{- range $placeholders -}}
  {{- $content = replace $content .placeholder .original -}}
{{- end -}}

{{- /* 6. Render the final processed content */ -}}
{{- .RenderString $content -}}   {{/* Pass the modified content back into Hugo’s Markdown renderer */}}
