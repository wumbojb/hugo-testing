{{/* --- Utility: build dictionary for wikilink resolution --- */}}
{{- $wikilinkMap := dict -}}   {{/* Create an empty dictionary to store link lookups */}}
{{- range $p := union site.RegularPages site.Sections }}   {{/* Loop through all regular pages + section pages */}}
  {{- if $p.File }}   {{/* Only process if the page has an associated file */}}
    {{- $base := lower $p.File.BaseFileName }}   {{/* Get file base name, lowercase (e.g. "Note.md" -> "note") */}}
    {{- $path := lower (replace (replace $p.File.Path "\\" "/") ".md" "") }}   
    {{/* Normalize path: replace backslashes with slashes, remove .md, lowercase */}}

    {{/* Save aliases into the lookup dictionary */}}
    {{- $wikilinkMap = merge $wikilinkMap (dict $base $p) -}}   {{/* Allow lookup by base filename */}}
    {{- $wikilinkMap = merge $wikilinkMap (dict $path $p) -}}   {{/* Allow lookup by normalized path */}}
    {{- range $p.Aliases }}   {{/* If page has defined aliases, also store them */}}
      {{- $wikilinkMap = merge $wikilinkMap (dict (lower .) $p) -}}
    {{- end -}}
  {{- end }}
{{- end }}

{{/* --- Templates for different link rendering cases --- */}}
{{ define "render-link-internal" }}
  <a class="link link--internal" href="{{ .href | safeURL }}">{{ .text }}</a>
{{ end }}

{{ define "render-external-link" }}
  <a class="link link--external"
     href="{{ .href | safeURL }}"
     rel="external noopener noreferrer nofollow"   {{/* Security: prevent leaking referrer and opener */}}
     target="_blank"                               {{/* Open external links in new tab */}}
     {{- with .title }}title="{{ . }}"{{ end -}}>
    {{- with .text }}{{ . }}{{ end -}}
  </a>
{{ end }}

{{ define "render-broken" }}
  <span class="link link--broken" title="Link to {{ .text }} is missing">{{ .text }}</span>
{{ end }}

{{/* --- Main link resolution logic --- */}}
{{- $destination := .Destination | default "" -}}   {{/* Destination (href) provided by Markdown parser */}}
{{- $text := .Text | safeHTML | default "" -}}      {{/* Text inside the link */}}
{{- $title := .Title | default "" -}}               {{/* Optional title attribute */}}

{{- $isWikilink := eq $destination "wikilink" -}}   {{/* Check if this link is a custom "wikilink" type */}}
{{- $isExternal := or
  (strings.HasPrefix $destination "http://")
  (strings.HasPrefix $destination "https://")
  (strings.HasPrefix $destination "mailto:")
-}}   {{/* Detect if the link is external (http/https/mailto) */}}

{{ if $isWikilink }}
  {{ $rawTitle := cond (ne $title "") $title $text }}   {{/* Prefer title if provided, else use text */}}
  {{ $parts := split $rawTitle "#" }}                   {{/* Split on "#" to separate anchor */}}
  {{ $targetRaw := index $parts 0 }}                    {{/* First part = target page */}}
  {{ $anchor := cond (gt (len $parts) 1) (printf "#%s" (index $parts 1)) "" }}   
  {{/* If anchor exists, prepend "#" */}}

  {{/* Normalize target: lowercase and strip ".md" extension */}}
  {{ $target := lower (replace $targetRaw ".md" "") }}

  {{ $page := index $wikilinkMap $target }}   {{/* Try to find page from dictionary */}}

  {{ if $page }}
    {{/* If found, render as internal link */}}
    {{ template "render-link-internal" (dict "href" (print $page.RelPermalink $anchor) "text" $text) }}
  {{ else }}
    {{/* If not found, mark as broken */}}
    {{ template "render-broken" (dict "text" $text) }}
  {{ end }}
{{ else if $isExternal }}
  {{/* Render as external link */}}
  {{ template "render-external-link" (dict "href" $destination "text" $text "title" $title) }}
{{ else }}
  {{- $u := urls.Parse $destination -}}   {{/* Parse the URL for further checks */}}
  {{ if $u.IsAbs }}
    {{/* Absolute URL: treat as external */}}
    {{ template "render-external-link" (dict "href" $destination "text" $text "title" $title) }}
  {{ else }}
    {{/* Otherwise, treat as internal (relative link) */}}
    {{ template "render-link-internal" (dict "href" $destination "text" $text) }}
  {{ end }}
{{ end }}
